#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2

# Function to log messages
log() {
  echo "$(date +%Y-%m-%d\ %H:%M:%S) - $1"
}

# Check required commands
required_commands=("curl" "tee" "sed")
for cmd in "${required_commands[@]}"; do
  if ! command -v "$cmd" >/dev/null; then
    log "Error: Required command '$cmd' is missing."
    exit 1
  fi
done

# Define environment variables
MW_API_KEY=kxtgxquehpxpwvrctbvmllaqwovspakftggg
MW_AGENT_HOME=${MW_AGENT_HOME:-/opt/mw-agent}

# Fetch the latest Middleware Agent version
get_latest_mw_agent_version() {
  local repo="middleware-labs/mw-agent"
  local latest_version
  latest_version=$(curl --silent "https://api.github.com/repos/$repo/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
  echo "${latest_version:-1.6.6}"
}

MW_VERSION=${MW_VERSION:-$(get_latest_mw_agent_version)}
log "Installing Middleware Agent version $MW_VERSION"

# Download and install Middleware Agent
log "Downloading Middleware Agent..."
curl -L -o "$BUILD_DIR/mw-agent.tar.gz" "https://github.com/middleware-labs/mw-agent/releases/download/$MW_VERSION/mw-agent-$MW_VERSION-linux-amd64.tar.gz"

log "Extracting Middleware Agent..."
tar -xzf "$BUILD_DIR/mw-agent.tar.gz" -C "$BUILD_DIR"

log "Moving Middleware Agent to $MW_AGENT_HOME..."
mkdir -p "$MW_AGENT_HOME"
mv "$BUILD_DIR/mw-agent" "$MW_AGENT_HOME/"

log "Middleware Agent installation completed successfully."
