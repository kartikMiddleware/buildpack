#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2

# Function to log messages
log() {
  echo "$(date +%Y-%m-%d\ %H:%M:%S) - $1"
}

# Check required commands
required_commands=("curl" "tee" "sed" "apt-get")
for cmd in "${required_commands[@]}"; do
  if ! command -v "$cmd" >/dev/null; then
    log "Error: Required command '$cmd' is missing."
    exit 1
  fi
done

# Prepare the directories
mkdir -p "$BUILD_DIR/.apt"

# Define environment variables
MW_API_KEY=kxtgxquehpxpwvrctbvmllaqwovspakftggg
MW_AGENT_HOME=${MW_AGENT_HOME:-/opt/mw-agent}
MW_APT_LIST=${MW_APT_LIST:-mw-agent.list}
MW_AGENT_BINARY=${MW_AGENT_BINARY:-mw-agent}

# Fetch the latest Middleware Agent version
get_latest_mw_agent_version() {
  local repo="middleware-labs/mw-agent"
  local latest_version
  latest_version=$(curl --silent "https://api.github.com/repos/$repo/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
  echo "${latest_version:-1.6.6}"
}

MW_VERSION=${MW_VERSION:-$(get_latest_mw_agent_version)}
log "Installing Middleware Agent version $MW_VERSION"

# Add APT repository
log "Adding Middleware Agent APT repository..."
echo "deb [signed-by=/tmp/middleware-keyring.gpg] https://apt.middleware.io/public stable main" | tee "$BUILD_DIR/$MW_APT_LIST"

# Add the GPG key to a writable location
log "Fetching GPG key..."
if ! curl -fsSL https://apt.middleware.io/gpg-keys/mw-agent-apt-public.key | gpg --dearmor -o "/tmp/middleware-keyring.gpg"; then
  log "Error: Failed to fetch GPG key."
  exit 1
fi

# Update APT and install the agent
log "Updating APT package lists..."
if ! apt-get update -o Dir::Etc::sourcelist="sources.list.d/$MW_APT_LIST" -o Dir::Etc::sourceparts="-" -o APT::Get::List-Cleanup="0"; then
  log "Error: Failed to update APT package lists."
  exit 1
fi

log "Installing Middleware Agent..."
if ! apt-get install -y "$MW_AGENT_BINARY=$MW_VERSION"; then
  log "Error: Failed to install Middleware Agent."
  exit 1
fi

log "Middleware Agent installation completed successfully."
